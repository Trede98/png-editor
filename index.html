<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PNG Background Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ------------------------------------------------------
   THEME VARIABLES
------------------------------------------------------ */
:root {
    --bg: #f5f5f5;
    --card: #ffffff;
    --text: #111111;
    --border: #c7c7c7;
    --subtle: #777777;
    --toolbar-bg: rgba(255,255,255,0.96);
}

body.dark {
    --bg: #101010;
    --card: #1c1c1c;
    --text: #f3f3f3;
    --border: #555555;
    --subtle: #aaaaaa;
    --toolbar-bg: rgba(16,16,16,0.96);
}

/* ------------------------------------------------------
   GENERAL PAGE LAYOUT
------------------------------------------------------ */
body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                 "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
    padding: 16px;
    box-sizing: border-box;
}

#app {
    background: var(--card);
    border-radius: 18px;
    max-width: 1200px;
    width: 100%;
    min-height: calc(100vh - 32px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.12);
    padding: 0;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    overflow: hidden;
}

/* ------------------------------------------------------
   TOP BAR
------------------------------------------------------ */
.top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    gap: 8px;
}

.top-bar-left {
    display: flex;
    align-items: center;
    gap: 4px;
}

.top-bar-right {
    display: flex;
    align-items: center;
    gap: 6px;
}

.title {
    font-weight: 600;
    font-size: 16px;
    text-align: center;
    flex: 1;
}

.icon-btn {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: none;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    cursor: pointer;
    color: var(--text);
    transition: background 0.15s ease, transform 0.08s ease, opacity 0.2s ease;
}

.icon-btn:disabled {
    opacity: 0.25;
    cursor: default;
}

.icon-btn:not(:disabled):hover {
    background: rgba(0,0,0,0.05);
}

body.dark .icon-btn:not(:disabled):hover {
    background: rgba(255,255,255,0.06);
}

.subtitle {
    font-size: 12px;
    color: var(--subtle);
    text-align: center;
    padding: 0 16px 4px;
    margin: 0;
}

/* Language dropdown */
.lang-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.lang-dropdown {
    position: absolute;
    top: 110%;
    right: 0;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    padding: 4px 0;
    min-width: 130px;
    z-index: 20;
}

.lang-dropdown.hidden {
    display: none;
}

.lang-dropdown button {
    width: 100%;
    background: none;
    border: none;
    padding: 6px 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text);
    text-align: left;
}

.lang-dropdown button span.flag {
    font-size: 16px;
}

.lang-dropdown button span.label {
    flex: 1;
}

.lang-dropdown button.active {
    font-weight: 600;
    background: rgba(0,0,0,0.06);
}

body.dark .lang-dropdown {
    background: var(--card);
}

/* ------------------------------------------------------
   DESKTOP LAYOUT
------------------------------------------------------ */
.main-desktop {
    flex: 1;
    display: none;
    overflow: hidden;
}

.sidebar {
    width: 260px;
    padding: 18px 14px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    display: none;
    box-sizing: border-box;
}

.desktop-preview-area {
    flex: 1;
    padding: 20px;
    display: none;
    box-sizing: border-box;
}

.desktop-preview-wrapper {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: auto;
    border-radius: 16px;
    background: rgba(0,0,0,0.02);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Desktop dropzone */
#dropzone-desktop {
    border: 1.6px dashed var(--border);
    border-radius: 14px;
    padding: 40px 20px;
    cursor: pointer;
    color: var(--subtle);
    text-align: center;
    background: rgba(0,0,0,0.01);
    max-width: 420px;
    width: 100%;
}

#dropzone-desktop.dragover {
    border-color: #4caf50;
    background: rgba(76,175,80,0.08);
}

#drop-desktop-main {
    display: block;
    color: var(--text);
    margin-bottom: 4px;
}

#drop-desktop-hint {
    font-size: 12px;
    color: var(--subtle);
    display: block;
}

#preview-desktop {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 14px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.2);
    opacity: 1;
    display: none;
    transition: opacity 0.12s ease;
}

/* ------------------------------------------------------
   MOBILE LAYOUT
------------------------------------------------------ */
.mobile-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 12px 14px 0;
    box-sizing: border-box;
    justify-content: center;
    align-items: center;
}

/* when we have an image, distribute preview + bottom panel nicely */
body.image-loaded .mobile-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#dropzone-mobile {
    border: 1.6px dashed var(--border);
    border-radius: 14px;
    padding: 28px 14px;
    cursor: pointer;
    color: var(--subtle);
    text-align: center;
    background: rgba(0,0,0,0.01);
    max-width: 420px;
}

#dropzone-mobile.dragover {
    border-color: #4caf50;
    background: rgba(76,175,80,0.08);
}

#drop-mobile-main {
    display: block;
    color: var(--text);
    margin-bottom: 4px;
}

#drop-mobile-hint {
    font-size: 12px;
    color: var(--subtle);
    display: block;
}

/* Preview between top and bottom */
.mobile-preview-wrapper {
    flex: 1;
    display: none;
    flex-direction: column;
}

.mobile-preview-inner {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
}

#preview-mobile {
    max-width: 100%;
    max-height: 60vh;
    border-radius: 14px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.2);
    display: none;
    transition: opacity 0.12s ease;
}

/* MOBILE BOTTOM PANEL */
#mobile-toolbar {
    display: none;
    padding: 14px 14px 18px;
    background: var(--toolbar-bg);
    backdrop-filter: blur(10px);
    border-radius: 20px;          /* all corners rounded */
    margin: 10px 12px 18px;       /* horizontal + bottom margin */
}

/* ------------------------------------------------------
   COLOR TILES
------------------------------------------------------ */
.tool-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--subtle);
    margin-bottom: 6px;
}

.color-picker-tile {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 2px dashed var(--border);
    position: relative;
    overflow: hidden;
    flex-shrink: 0; /* important for scrolling */
}

.color-picker-tile::after {
    content: "üé®";
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--subtle);
    pointer-events: none;
}

.color-picker-tile input[type="color"] {
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.color-tile {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid var(--border);
    cursor: pointer;
    flex-shrink: 0;
}

.color-tile.placeholder {
    border-style: dashed;
    background: transparent;
}

/* Desktop 3x3 grids */
.color-grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 6px;
}

/* Mobile rows */
.mobile-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
    overflow-x: auto;
}

.recent-row-mobile {
    display: flex;
    gap: 8px;
}

.preset-row-mobile {
    display: flex;
    gap: 8px;
}

/* ------------------------------------------------------
   EXPORT BUTTONS
------------------------------------------------------ */
.export-buttons {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.export-btn {
    flex: 1;
    padding: 10px 10px;
    border-radius: 10px;
    border: none;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    color: #fff;
    transition: background 0.18s ease, transform 0.08s ease, opacity 0.2s ease;
}

.export-btn.png { background: #4caf50; }
.export-btn.jpg { background: #1976d2; }

.export-btn:disabled {
    opacity: 0.45;
    cursor: default;
}

/* ------------------------------------------------------
   RESPONSIVE
------------------------------------------------------ */
@media (min-width: 768px) {
    .mobile-main,
    #mobile-toolbar {
        display: none !important;
    }
    .sidebar,
    .desktop-preview-area {
        display: block;
    }
    .main-desktop {
        display: flex;
    }
}
</style>
</head>
<body>
<div id="app">

    <!-- HEADER -->
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="icon-btn" id="resetBtn" disabled title="Clear image">‚Ü∫</button>
        </div>

        <div class="title">PNG Background Editor</div>

        <div class="top-bar-right">
            <div class="lang-wrapper">
                <button class="icon-btn" id="langBtn" title="Change language">üá¨üáß ‚ñº</button>
                <div id="langDropdown" class="lang-dropdown hidden">
                    <button type="button" data-lang="en" data-lang-option="en">
                        <span class="flag">üá¨üáß</span>
                        <span class="label">English</span>
                    </button>
                    <button type="button" data-lang="it" data-lang-option="it">
                        <span class="flag">üáÆüáπ</span>
                        <span class="label">Italiano</span>
                    </button>
                </div>
            </div>
            <button class="icon-btn" id="darkModeBtn" title="Toggle dark mode">‚òÄÔ∏è</button>
        </div>
    </div>
    <p class="subtitle">Upload a transparent PNG, choose a background color, and export for print.</p>

    <!-- DESKTOP LAYOUT -->
    <div class="main-desktop">
        <aside class="sidebar">
            <div class="tool-title" data-i18n="customColors">Custom colors</div>

            <!-- 3x3: picker + 8 recents -->
            <div id="recent-grid-desktop" class="color-grid-3">
                <div class="color-picker-tile">
                    <input type="color" id="bgcolor-desktop" value="#ffffff">
                </div>
                <!-- 8 recent tiles injected by JS -->
            </div>

            <div class="tool-title" style="margin-top:12px;" data-i18n="presets">Presets</div>
            <div id="preset-colors-desktop" class="color-grid-3"></div>

            <div class="tool-title" style="margin-top:16px;" data-i18n="export">Export</div>
            <div class="export-buttons">
                <button id="downloadPngBtn" class="export-btn png" disabled>PNG</button>
                <button id="downloadJpgBtn" class="export-btn jpg" disabled>JPG</button>
            </div>
        </aside>

        <div class="desktop-preview-area">
            <div class="desktop-preview-wrapper">
                <div id="dropzone-desktop">
                    <strong id="drop-desktop-main">Click or drop a PNG image</strong>
                    <span id="drop-desktop-hint">Transparent PNGs look best on colored backgrounds.</span>
                </div>
                <img id="preview-desktop" alt="Preview">
            </div>
        </div>
    </div>

    <!-- MOBILE LAYOUT -->
    <div class="mobile-main">
        <div id="dropzone-mobile">
            <strong id="drop-mobile-main">Tap or drop a PNG image</strong>
            <span id="drop-mobile-hint">Transparent PNGs look best on colored backgrounds.</span>
        </div>

        <div class="mobile-preview-wrapper" id="mobile-preview-section">
            <div class="mobile-preview-inner">
                <img id="preview-mobile" alt="Preview">
            </div>
        </div>
    </div>

    <!-- MOBILE TOOLBAR -->
    <section id="mobile-toolbar">
        <div class="tool-title" data-i18n="customColors">Custom colors</div>

        <!-- Row 1: picker + 8 recents -->
        <div class="mobile-row">
            <div class="color-picker-tile">
                <input type="color" id="bgcolor-mobile" value="#ffffff">
            </div>
            <div class="recent-row-mobile" id="recent-colors-mobile"></div>
        </div>

        <!-- Row 2: presets -->
        <div class="mobile-row" style="margin-top:10px;">
            <div id="preset-colors-mobile" class="preset-row-mobile"></div>
        </div>

        <div class="tool-title" style="margin-top:10px;" data-i18n="export">Export</div>
        <div class="export-buttons">
            <button id="downloadPngBtnMobile" class="export-btn png" disabled>PNG</button>
            <button id="downloadJpgBtnMobile" class="export-btn jpg" disabled>JPG</button>
        </div>
    </section>

    <input type="file" id="fileInput" accept="image/png" hidden>

</div>

<script>
/* ---------------------- TRANSLATIONS ---------------------- */
const LANG = {
    en: {
        title: "PNG Background Editor",
        subtitle: "Upload a transparent PNG, choose a background color, and export for print.",
        customColors: "Custom colors",
        presets: "Presets",
        export: "Export",
        dropDesktopMain: "Click or drop a PNG image",
        dropDesktopHint: "Transparent PNGs look best on colored backgrounds.",
        dropMobileMain: "Tap or drop a PNG image",
        dropMobileHint: "Transparent PNGs look best on colored backgrounds.",
        exportPng: "PNG",
        exportJpg: "JPG",
        resetTooltip: "Clear image",
        darkTooltip: "Toggle dark mode",
        langButtonTitle: "Change language",
        langButtonContent: "üá¨üáß",
        lang_en: "English",
        lang_it: "Italiano"
    },
    it: {
        title: "Editor dello sfondo PNG",
        subtitle: "Carica un PNG trasparente, scegli un colore di sfondo ed esporta per la stampa.",
        customColors: "Colori personalizzati",
        presets: "Colori predefiniti",
        export: "Esporta",
        dropDesktopMain: "Clicca o trascina un'immagine PNG",
        dropDesktopHint: "I PNG trasparenti rendono meglio su sfondi colorati.",
        dropMobileMain: "Tocca o trascina un'immagine PNG",
        dropMobileHint: "I PNG trasparenti rendono meglio su sfondi colorati.",
        exportPng: "PNG",
        exportJpg: "JPG",
        resetTooltip: "Rimuovi immagine",
        darkTooltip: "Attiva/disattiva tema scuro",
        langButtonTitle: "Cambia lingua",
        langButtonContent: "üáÆüáπ",
        lang_en: "Inglese",
        lang_it: "Italiano"
    }
};

const PRESET_COLORS = [
    "#F4C9A3","#E59A6D","#A8C39A","#6FA7A5",
    "#EFE3D4","#7CB7B3","#5E8E99","#D5B89F",
    "#D9D9D9"
];

let currentLang = localStorage.getItem("lang") || "en";
let recentColors = [];
let currentImage = null;
let originalFilename = null;
let currentMode = window.innerWidth < 768 ? "mobile" : "desktop";

const resetBtn = document.getElementById("resetBtn");
const darkModeBtn = document.getElementById("darkModeBtn");
const langBtn = document.getElementById("langBtn");
const langDropdown = document.getElementById("langDropdown");

const previewMobile = document.getElementById("preview-mobile");
const previewDesktop = document.getElementById("preview-desktop");
const dropzoneMobile = document.getElementById("dropzone-mobile");
const dropzoneDesktop = document.getElementById("dropzone-desktop");
const mobilePreviewSection = document.getElementById("mobile-preview-section");
const mobileToolbar = document.getElementById("mobile-toolbar");
const fileInput = document.getElementById("fileInput");

const bgPickerDesktop = document.getElementById("bgcolor-desktop");
const bgPickerMobile = document.getElementById("bgcolor-mobile");

const recentDesktopGrid = document.getElementById("recent-grid-desktop");
const recentMobileContainer = document.getElementById("recent-colors-mobile");

const presetDesktopContainer = document.getElementById("preset-colors-desktop");
const presetMobileContainer = document.getElementById("preset-colors-mobile");

const btnPng = document.getElementById("downloadPngBtn");
const btnJpg = document.getElementById("downloadJpgBtn");
const btnPngMobile = document.getElementById("downloadPngBtnMobile");
const btnJpgMobile = document.getElementById("downloadJpgBtnMobile");

let pickerTimer = null;

/* ---------------------- LANGUAGE APPLY ---------------------- */
function applyLanguage() {
    const t = LANG[currentLang];

    document.documentElement.lang = currentLang;

    // Title + subtitle
    document.querySelector(".title").textContent = t.title;
    document.querySelector(".subtitle").textContent = t.subtitle;

    // Tool titles
    document.querySelectorAll('[data-i18n="customColors"]').forEach(el => {
        el.textContent = t.customColors;
    });
    document.querySelectorAll('[data-i18n="presets"]').forEach(el => {
        el.textContent = t.presets;
    });
    document.querySelectorAll('[data-i18n="export"]').forEach(el => {
        el.textContent = t.export;
    });

    // Dropzones
    document.getElementById("drop-desktop-main").textContent = t.dropDesktopMain;
    document.getElementById("drop-desktop-hint").textContent = t.dropDesktopHint;
    document.getElementById("drop-mobile-main").textContent = t.dropMobileMain;
    document.getElementById("drop-mobile-hint").textContent = t.dropMobileHint;

    // Export buttons
    btnPng.textContent = t.exportPng;
    btnJpg.textContent = t.exportJpg;
    btnPngMobile.textContent = t.exportPng;
    btnJpgMobile.textContent = t.exportJpg;

    // Tooltips
    resetBtn.title = t.resetTooltip;
    darkModeBtn.title = t.darkTooltip;
    langBtn.title = t.langButtonTitle;

    // Language button flag
    langBtn.textContent = t.langButtonContent;

    // Language dropdown labels
    const btnLangEn = langDropdown.querySelector('[data-lang-option="en"] .label');
    const btnLangIt = langDropdown.querySelector('[data-lang-option="it"] .label');
    if (btnLangEn && btnLangIt) {
        btnLangEn.textContent = t.lang_en;
        btnLangIt.textContent = t.lang_it;
    }

    // Active language highlight
    langDropdown.querySelectorAll("button[data-lang-option]").forEach(btn => {
        const langCode = btn.getAttribute("data-lang-option");
        btn.classList.toggle("active", langCode === currentLang);
    });
}

/* ---------------------- INIT ---------------------- */
window.addEventListener("DOMContentLoaded", () => {
    const darkSaved = localStorage.getItem("darkMode") === "true";
    document.body.classList.toggle("dark", darkSaved);
    darkModeBtn.textContent = darkSaved ? "üåô" : "‚òÄÔ∏è";

    const stored = localStorage.getItem("recentColors");
    if (stored) {
        try {
            const arr = JSON.parse(stored);
            if (Array.isArray(arr)) recentColors = arr;
        } catch {}
    }

    renderPresets();
    renderRecentColors();
    applyLanguage();
});

/* ---------------------- LANGUAGE EVENTS ---------------------- */
langBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    langDropdown.classList.toggle("hidden");
});

langDropdown.querySelectorAll("button[data-lang]").forEach(btn => {
    btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const lang = btn.getAttribute("data-lang");
        if (lang && (lang === "en" || lang === "it")) {
            currentLang = lang;
            localStorage.setItem("lang", currentLang);
            langDropdown.classList.add("hidden");
            applyLanguage();
        }
    });
});

// Close dropdown on outside click
document.addEventListener("click", (e) => {
    const wrapper = document.querySelector(".lang-wrapper");
    if (!wrapper.contains(e.target)) {
        langDropdown.classList.add("hidden");
    }
});

/* ---------------------- DARK MODE ---------------------- */
darkModeBtn.addEventListener("click", () => {
    const nowDark = !document.body.classList.contains("dark");
    document.body.classList.toggle("dark", nowDark);
    localStorage.setItem("darkMode", nowDark);
    darkModeBtn.textContent = nowDark ? "üåô" : "‚òÄÔ∏è";
});

/* ---------------------- FILE HANDLING ---------------------- */
dropzoneMobile.addEventListener("click", () => fileInput.click());
dropzoneDesktop.addEventListener("click", () => fileInput.click());

dropzoneMobile.addEventListener("dragover", e => { e.preventDefault(); dropzoneMobile.classList.add("dragover"); });
dropzoneMobile.addEventListener("dragleave", () => dropzoneMobile.classList.remove("dragover"));
dropzoneMobile.addEventListener("drop", e => {
    e.preventDefault();
    dropzoneMobile.classList.remove("dragover");
    handleFile(e.dataTransfer.files[0]);
});

dropzoneDesktop.addEventListener("dragover", e => { e.preventDefault(); dropzoneDesktop.classList.add("dragover"); });
dropzoneDesktop.addEventListener("dragleave", () => dropzoneDesktop.classList.remove("dragover"));
dropzoneDesktop.addEventListener("drop", e => {
    e.preventDefault();
    dropzoneDesktop.classList.remove("dragover");
    handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener("change", () => handleFile(fileInput.files[0]));

async function handleFile(file) {
    if (!file || file.type !== "image/png") {
        alert(currentLang === "it"
            ? "Per favore carica un file PNG."
            : "Please upload a PNG file.");
        return;
    }

    originalFilename = file.name.replace(/\.[^.]+$/, "");

    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    currentImage = img;
    dropzoneMobile.style.display = "none";
    dropzoneDesktop.style.display = "none";

    resetBtn.disabled =
        btnPng.disabled =
        btnJpg.disabled =
        btnPngMobile.disabled =
        btnJpgMobile.disabled = false;

    document.body.classList.add("image-loaded");
    applyLayoutForMode();
}

/* ---------------------- LAYOUT ---------------------- */
function applyLayoutForMode() {
    if (!currentImage) return;

    if (currentMode === "mobile") {
        mobilePreviewSection.style.display = "flex";
        mobileToolbar.style.display = "block";
        previewDesktop.style.display = "none";
    } else {
        mobilePreviewSection.style.display = "none";
        mobileToolbar.style.display = "none";
        previewDesktop.style.display = "block";
    }

    updatePreview();
}

window.addEventListener("resize", () => {
    const newMode = window.innerWidth < 768 ? "mobile" : "desktop";
    if (newMode === currentMode) return;
    currentMode = newMode;
    if (currentImage) applyLayoutForMode();
});

/* ---------------------- PREVIEW ---------------------- */
function updatePreview() {
    if (!currentImage) return;

    const color = bgPickerDesktop.value;
    const canvas = document.createElement("canvas");
    canvas.width = currentImage.width;
    canvas.height = currentImage.height;
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = color;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(currentImage, 0, 0);

    const dataURL = canvas.toDataURL("image/png");

    if (currentMode === "mobile") {
        previewMobile.style.opacity = "0.15";
        previewMobile.onload = () => (previewMobile.style.opacity = "1");
        previewMobile.src = dataURL;
        previewMobile.style.display = "block";
    } else {
        previewDesktop.style.opacity = "0.15";
        previewDesktop.onload = () => (previewDesktop.style.opacity = "1");
        previewDesktop.src = dataURL;
        previewDesktop.style.display = "block";
    }
}

/* ---------------------- RECENT COLORS ---------------------- */
function normalizeColor(color) {
    const ctx = document.createElement("canvas").getContext("2d");
    ctx.fillStyle = color;
    return ctx.fillStyle;
}

function recordRecentColor(color) {
    const normalized = normalizeColor(color);

    recentColors = recentColors.filter(c => c !== normalized);
    recentColors.unshift(normalized);
    if (recentColors.length > 8) recentColors = recentColors.slice(0, 8);

    localStorage.setItem("recentColors", JSON.stringify(recentColors));
    renderRecentColors();
}

/* ---------------------- PICKERS (timer-based drag end) ---------------------- */
function handlePickerInput(source, value) {
    // sync the other picker
    if (source === "desktop") {
        bgPickerMobile.value = value;
    } else {
        bgPickerDesktop.value = value;
    }

    if (pickerTimer) clearTimeout(pickerTimer);
    pickerTimer = setTimeout(() => {
        recordRecentColor(value);
        updatePreview();
    }, 200);
}

bgPickerDesktop.addEventListener("input", () => {
    handlePickerInput("desktop", bgPickerDesktop.value);
});

bgPickerMobile.addEventListener("input", () => {
    handlePickerInput("mobile", bgPickerMobile.value);
});

/* ---------------------- PRESETS & RECENTS RENDER ---------------------- */
function renderPresets() {
    presetDesktopContainer.innerHTML = "";
    presetMobileContainer.innerHTML = "";

    PRESET_COLORS.forEach(color => {
        const tileD = document.createElement("div");
        tileD.className = "color-tile";
        tileD.style.backgroundColor = color;
        tileD.dataset.color = color;
        tileD.addEventListener("click", onPresetClicked);
        presetDesktopContainer.appendChild(tileD);

        const tileM = document.createElement("div");
        tileM.className = "color-tile";
        tileM.style.backgroundColor = color;
        tileM.dataset.color = color;
        tileM.addEventListener("click", onPresetClicked);
        presetMobileContainer.appendChild(tileM);
    });
}

function renderRecentColors() {
    // Desktop: keep picker as first child
    while (recentDesktopGrid.children.length > 1) {
        recentDesktopGrid.removeChild(recentDesktopGrid.lastChild);
    }

    for (let i = 0; i < 8; i++) {
        const val = recentColors[i];
        const tile = document.createElement("div");
        tile.className = "color-tile";
        if (val) {
            tile.style.backgroundColor = val;
            tile.dataset.color = val;
            tile.addEventListener("click", onRecentClicked);
        } else {
            tile.classList.add("placeholder");
        }
        recentDesktopGrid.appendChild(tile);
    }

    recentMobileContainer.innerHTML = "";
    for (let i = 0; i < 8; i++) {
        const val = recentColors[i];
        const tile = document.createElement("div");
        tile.className = "color-tile";
        if (val) {
            tile.style.backgroundColor = val;
            tile.dataset.color = val;
            tile.addEventListener("click", onRecentClicked);
        } else {
            tile.classList.add("placeholder");
        }
        recentMobileContainer.appendChild(tile);
    }
}

function onPresetClicked(e) {
    const color = e.currentTarget.dataset.color;
    bgPickerDesktop.value = color;
    bgPickerMobile.value = color;
    updatePreview(); // presets do NOT touch recents
}

function onRecentClicked(e) {
    const color = e.currentTarget.dataset.color;
    bgPickerDesktop.value = color;
    bgPickerMobile.value = color;
    updatePreview(); // recents do NOT reorder or re-save
}

/* ---------------------- RESET ---------------------- */
resetBtn.addEventListener("click", () => {
    currentImage = null;
    originalFilename = null;

    dropzoneMobile.style.display = "block";
    dropzoneDesktop.style.display = "block";

    previewMobile.src = "";
    previewDesktop.src = "";
    previewMobile.style.display = "none";
    previewDesktop.style.display = "none";

    mobilePreviewSection.style.display = "none";
    mobileToolbar.style.display = "none";

    resetBtn.disabled =
    btnPng.disabled =
    btnJpg.disabled =
    btnPngMobile.disabled =
    btnJpgMobile.disabled = true;

    fileInput.value = "";
    document.body.classList.remove("image-loaded");
});

/* ---------------------- EXPORT ---------------------- */
function exportImage(format) {
    if (!currentImage) return;

    const color = bgPickerDesktop.value;
    const canvas = document.createElement("canvas");
    canvas.width = currentImage.width;
    canvas.height = currentImage.height;
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = color;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(currentImage, 0, 0);

    const filename = `${originalFilename || "image"}_bg.${format}`;
    const link = document.createElement("a");
    link.download = filename;
    link.href = format === "jpg"
        ? canvas.toDataURL("image/jpeg", 0.95)
        : canvas.toDataURL("image/png");
    link.click();
}

btnPng.addEventListener("click", () => exportImage("png"));
btnJpg.addEventListener("click", () => exportImage("jpg"));
btnPngMobile.addEventListener("click", () => exportImage("png"));
btnJpgMobile.addEventListener("click", () => exportImage("jpg"));
</script>

</body>
</html>
